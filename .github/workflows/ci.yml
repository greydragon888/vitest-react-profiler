name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Type check
        run: npm run typecheck

  validate-codeowners:
    name: Validate CODEOWNERS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: GitHub CODEOWNERS Validator
        uses: mszostok/codeowners-validator@v0.7.4
        with:
          # Skip 'owners' check for personal repos (only works for orgs)
          checks: "files,duppatterns,syntax"
          experimental_checks: "notowned"

  test:
    name: Test (Node ${{ matrix.node }} + React ${{ matrix.react }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]
        react: [18, 19]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install React ${{ matrix.react }}
        if: matrix.react != 19
        run: |
          npm install --save-dev react@^${{ matrix.react }}.0.0 react-dom@^${{ matrix.react }}.0.0
          npm install --save-dev @types/react@^${{ matrix.react }}.0.0 @types/react-dom@^${{ matrix.react }}.0.0

      - name: Run tests with coverage
        run: npm run test:coverage -- --reporter=default --reporter=junit --outputFile.junit=test-report.junit.xml

      - name: Upload coverage to Codecov
        if: matrix.node == 20 && matrix.react == 19
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-coverage
          fail_ci_if_error: false

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./test-report.junit.xml

  property-test:
    name: Property-Based Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Check if relevant files changed
        id: changes
        run: |
          # Get changed files between HEAD and HEAD~1
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Check if src/, tests/property/, or property config changed
          if echo "$CHANGED_FILES" | grep -qE '^(src/|tests/property/|vitest\.config\.properties\.mts)'; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Relevant files changed - running property tests"
            echo "$CHANGED_FILES" | grep -E '^(src/|tests/property/|vitest\.config)' | head -10
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏭️ No relevant changes - skipping property tests"
            echo "Changed files:"
            echo "$CHANGED_FILES" | head -10
          fi

      - name: Setup Node.js
        if: steps.changes.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        if: steps.changes.outputs.should_run == 'true'
        run: npm ci

      - name: Run property-based tests
        if: steps.changes.outputs.should_run == 'true'
        run: npm run test:properties

      - name: Upload property test results
        if: always() && steps.changes.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: property-test-results
          path: |
            test-results/
            coverage/
          retention-days: 7

      - name: Skip property tests (no relevant changes)
        if: steps.changes.outputs.should_run != 'true'
        run: echo "⏭️ Property tests skipped - no changes to src/, tests/property/, or vitest.config.properties.mts"

  stress-test:
    name: Stress Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Check if relevant files changed
        id: changes
        run: |
          # Get changed files between HEAD and HEAD~1
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Check if src/, tests/stress/, or stress config changed
          if echo "$CHANGED_FILES" | grep -qE '^(src/|tests/stress/|vitest\.stress\.config\.mts)'; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Relevant files changed - running stress tests"
            echo "$CHANGED_FILES" | grep -E '^(src/|tests/stress/|vitest\.stress)' | head -10
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏭️ No relevant changes - skipping stress tests"
            echo "Changed files:"
            echo "$CHANGED_FILES" | head -10
          fi

      - name: Setup Node.js
        if: steps.changes.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        if: steps.changes.outputs.should_run == 'true'
        run: npm ci

      - name: Run stress tests
        if: steps.changes.outputs.should_run == 'true'
        run: npm run test:stress
        env:
          NODE_OPTIONS: "--expose-gc"

      - name: Upload stress test results
        if: always() && steps.changes.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: stress-test-results
          path: |
            test-results/
            .vitest-stress/
          retention-days: 7

      - name: Skip stress tests (no relevant changes)
        if: steps.changes.outputs.should_run != 'true'
        run: echo "⏭️ Stress tests skipped - no changes to src/, tests/stress/, or vitest.stress.config.mts"

  mutation-test:
    name: Mutation Testing
    runs-on: ubuntu-latest
    # Run mutation tests only when:
    # 1. Push to master branch AND
    # 2. Source or test files changed (skip for docs/workflow-only changes)
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Check if source/test files changed
        id: changes
        run: |
          # Get changed files between HEAD and HEAD~1
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Check if any src/ or tests/ files changed
          if echo "$CHANGED_FILES" | grep -qE '^(src/|tests/)'; then
            echo "source_changed=true" >> $GITHUB_OUTPUT
            echo "✅ Source/test files changed - running mutation tests"
            echo "$CHANGED_FILES" | grep -E '^(src/|tests/)' | head -10
          else
            echo "source_changed=false" >> $GITHUB_OUTPUT
            echo "⏭️ No source/test changes - skipping mutation tests"
            echo "Changed files:"
            echo "$CHANGED_FILES" | head -10
          fi

      - name: Setup Node.js
        if: steps.changes.outputs.source_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        if: steps.changes.outputs.source_changed == 'true'
        run: npm ci

      # Cache Stryker incremental results for faster subsequent runs
      # Key includes hash of src/ and tests/ to invalidate on code changes
      - name: Cache Stryker incremental results
        if: steps.changes.outputs.source_changed == 'true'
        uses: actions/cache@v4
        with:
          path: .stryker-tmp/incremental.json
          key: stryker-incremental-${{ runner.os }}-${{ hashFiles('src/**', 'tests/**/*.test.ts', 'tests/**/*.test.tsx') }}
          restore-keys: |
            stryker-incremental-${{ runner.os }}-

      - name: Run mutation tests
        if: steps.changes.outputs.source_changed == 'true'
        run: npm run test:mutation
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

      - name: Skip mutation tests (no source changes)
        if: steps.changes.outputs.source_changed != 'true'
        run: echo "⏭️ Mutation tests skipped - no changes to src/ or tests/"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Check build outputs
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "ESM build missing"
            exit 1
          fi
          if [ ! -f "dist/index.cjs" ]; then
            echo "CJS build missing"
            exit 1
          fi
          if [ ! -f "dist/index.d.ts" ]; then
            echo "Type definitions missing"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Test basic example
        run: |
          cd examples/basic
          npm install
          npm test

      - name: Test memoization example
        run: |
          cd examples/memoization
          npm install
          npm test

      - name: Test performance example
        run: |
          cd examples/performance
          npm install
          npm test

  test-installation:
    name: Test Package Installation
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Pack and create test project
        run: |
          npm pack
          mkdir test-project
          cd test-project
          npm init -y
          npm install react react-dom vitest @testing-library/react
          npm install ../vitest-react-profiler-*.tgz
          ls -la node_modules/vitest-react-profiler/dist/

      - name: Test ESM import
        run: |
          cd test-project
          cat > test.mjs << 'EOF'
          import { withProfiler } from 'vitest-react-profiler';
          console.log('✅ ESM import successful');
          console.log('withProfiler:', typeof withProfiler);
          EOF
          node test.mjs

      - name: Test TypeScript definitions
        run: |
          cd test-project
          npm install -D typescript @types/react
          cat > test.ts << 'EOF'
          import { withProfiler, ProfiledComponent } from 'vitest-react-profiler';
          import * as React from 'react';
          const Component: React.FC = () => React.createElement('div');
          const profiled: ProfiledComponent<{}> & React.ComponentType<{}> = withProfiler(Component);
          console.log('✅ TypeScript definitions work');
          EOF
          npx tsc test.ts --noEmit --esModuleInterop --jsx react --moduleResolution node --lib ES2022,DOM,DOM.Iterable
